import { useState, useEffect, useRef } from 'react';

const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
const CHARACTERISTIC_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
const MAX_CHUNK_SIZE = 10; // Maximum bytes per BLE packet

class BLEManager {
  constructor() {
    this.device = null;
    this.characteristic = null;
    this.isConnected = false;
    this.messageBuffer = '';
    this.listeners = new Set();
  }

  addListener(callback) {
    this.listeners.add(callback);
    return () => this.listeners.delete(callback);
  }

  notifyListeners(data) {
    this.listeners.forEach(listener => listener(data));
  }

  async connect() {
    try {
      this.device = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'ESP32-RELAY' }],
        optionalServices: [SERVICE_UUID]
      });

      const server = await this.device.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      this.characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

      await this.characteristic.startNotifications();
      this.characteristic.addEventListener('characteristicvaluechanged', this.handleNotification.bind(this));

      this.device.addEventListener('gattserverdisconnected', this.handleDisconnect.bind(this));
      
      this.isConnected = true;
      this.notifyListeners({ type: 'connected' });
      return true;
    } catch (error) {
      console.error('BLE Connection Error:', error);
      this.notifyListeners({ type: 'error', message: error.message });
      return false;
    }
  }

  handleNotification(event) {
    const value = event.target.value;
    const decoder = new TextDecoder('utf-8');
    const chunk = decoder.decode(value);
    
    this.messageBuffer += chunk;
    
    if (this.messageBuffer.includes('*')) {
      const messages = this.messageBuffer.split('*');
      this.messageBuffer = messages.pop() || '';
      
      messages.forEach(msg => {
        if (msg.trim()) {
          this.notifyListeners({ type: 'message', data: msg.trim() });
        }
      });
    }
  }

  handleDisconnect() {
    this.isConnected = false;
 